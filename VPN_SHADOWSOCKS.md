# Предварительные условия
У вас есть роутер Keenetic, поднят внешний сервер VPN и стандартными средствами Keenetic к нему подключен тунель. Вероятно даже с использованием доменного перенаправления трафика, как описано тут: [Перенаправление всего трафика на VPN](VPN.md). А также поднят внешний сервер shadowsocks.

# Основная идея
Пустить трафик VPN через Shadowsocks для полной анонимизации трафика, потому что любые VPN туннели легко обнаруживаются. Для еще более сложно обнаружимой маскировки под SSL/TLS/Websocket можно использовать v2ray plugin, но это тема отдельной статьи.

**ВАЖНО!** К сожалению, метод показал очень плохие результаты по скорости. Скорость падает в 5-6 раз относительно прямого соединения Wireguard или чистого Shadowsocks. Потому для меня он не подошел. Альтернатива `ss-tunnel` - полностью завернуть весь TCP и UDP трафик в Shadowsocks через ss-redir и iptables, включая любые туннели. Такое можно сделать, завернув весь локальный трафик роутера на SS, как описано тут [Перенаправление всего трафика на SS без утечек](ALL_SHADOWSOCKS.md). К сожалению, прироста в скорости он не дает никакого, так что нет смысла заморачиваться.

# Поехали
1. Установить Entware, лучше во внутреннюю память роутера, но можно и на флешку. Все пакеты в памяти займут не больше 16Мб, такой объем есть на всех роутерах Keenetic.
[Инструкция](https://help.keenetic.com/hc/ru/articles/360021888880-%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0-OPKG-Entware-%D0%BD%D0%B0-%D0%B2%D1%81%D1%82%D1%80%D0%BE%D0%B5%D0%BD%D0%BD%D1%83%D1%8E-%D0%BF%D0%B0%D0%BC%D1%8F%D1%82%D1%8C-%D1%80%D0%BE%D1%83%D1%82%D0%B5%D1%80%D0%B0)

   **ВАЖНО!** При маунте storage с папкой Install начинается процесс установки. Он может занять время, надо смотреть логи в "Диагностика" в интерфейсе. После установки будет доступен SSH с параметрами из логов.

   Получили доступ к SSH с Entware, заходим туда.

2. 
   ```bash
   opkg update
   opkg install mc shadowsocks-libev-ss-tunnel shadowsocks-libev-config
   ```

   С первого раза может не установится из-за ограниченной памяти и скачивания всего сразу, можно выполнить второй раз.
   
## Настройка shadowsocks клиента. 

Запускать будем в режиме туннеля (ss-tunnel). Для этого редактируем файл `/opt/etc/init.d/S22shadowsocks`, нужно убедиться, что запуск и аргументы корректны, должно быть
```bash
PROCS=ss-tunnel
ARGS="-s <ss-server-ip> -p <ss-server-port> -l <local-listneng-port> -L <vpn-server-ip>:<vpn-server-port> -k <password> -m chacha20-ietf-poly1305 -u"
```
Ну конечно меняем содержимое под настройки нашего внешнего сервера. Алгоритм `chacha20-ietf-poly1305` лучше не менять, из рекомендованных к использованию он самый быстрый. Главное отличие от стандартного запуска, аргумент `-L <vpn-server-ip>:<vpn-server-port>` - это тот адрес сервера VPN, который вы вводите в VPN клиенте, подключаясь к нему напрямую. Теперь на этот адрес будет перенаправлять Shadowsocks.

Теперь управление сервисом можно осуществлять через `/etc/init.d/S22shadowsocks start|stop|restart`

После этого достаточно подключаться VPN клиентом не к серверу VPN напрямую, а на `127.0.0.1:<local-listneng-port>`

**Полезное для диагностики:**
- Запуск shadowsocks в консоли для просмотра вывода: `ss-tunnel <ARGS> -v`
- Проверка открытых портов `netstat -lnp`

## MTU
Так как Shadowsocks увеличивает размер пакетов, нужно уменьшить MTU у интерфейсов VPN на клиенте и на сервере. Подробнее https://github.com/shadowsocks/shadowsocks-rust/issues/785
